import { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import styles from "./LetterSection.module.css";

const LETTER_TEXT = `–ù–∞—Å—Ç—è, —è —Ö–æ—á—É —Å–∫–∞–∑–∞—Ç—å —Ç–µ–±–µ –∫–æ–µ-—á—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ–µ.

–ò–Ω–æ–≥–¥–∞ –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª–æ–≤ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ, —á—Ç–æ–±—ã –æ–ø–∏—Å–∞—Ç—å –≤—Å—ë, —á—Ç–æ —è –∫ —Ç–µ–±–µ —á—É–≤—Å—Ç–≤—É—é. –ù–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–ø—Ä–æ–±—É—é.

–¢—ã –ø–æ—è–≤–∏–ª–∞—Å—å –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ –∏ –∫–∞–∫–∏–º-—Ç–æ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Å–¥–µ–ª–∞–ª–∞ –µ—ë —Å–≤–µ—Ç–ª–µ–µ, —Ç–µ–ø–ª–µ–µ –∏ –¥–æ–±—Ä–µ–µ. –†—è–¥–æ–º —Å —Ç–æ–±–æ–π –¥–∞–∂–µ —Å–∞–º—ã–µ –æ–±—ã—á–Ω—ã–µ –¥–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –æ—Å–æ–±–µ–Ω–Ω—ã–º–∏. –° —Ç–æ–±–æ–π —Ö–æ—á–µ—Ç—Å—è —Å–º–µ—è—Ç—å—Å—è –≥—Ä–æ–º—á–µ, –º–µ—á—Ç–∞—Ç—å —Å–º–µ–ª–µ–µ –∏ –ø—Ä–æ—Å—Ç–æ –∂–∏—Ç—å –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É.

–Ø –ª—é–±–ª—é —Ç–æ, –∫–∞–∫ —Ç—ã —É–ª—ã–±–∞–µ—à—å—Å—è.  
–õ—é–±–ª—é, –∫–∞–∫ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –∏—Å—Ç–æ—Ä–∏–∏.  
–õ—é–±–ª—é —Ç–≤–æ–π –≥–æ–ª–æ—Å, —Ç–≤–æ–π —Å–º–µ—Ö, —Ç–≤–æ–π –≤–∑–≥–ª—è–¥.  
–õ—é–±–ª—é –¥–∞–∂–µ —Ç–≤–æ–∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç —Ç–µ–±—è –∏–º–µ–Ω–Ω–æ —Ç–æ–±–æ–π.

–° —Ç–æ–±–æ–π –º–Ω–µ —Å–ø–æ–∫–æ–π–Ω–æ.  
–° —Ç–æ–±–æ–π –º–Ω–µ —Ä–∞–¥–æ—Å—Ç–Ω–æ.  
–° —Ç–æ–±–æ–π —è —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è –¥–æ–º–∞.

–°–ø–∞—Å–∏–±–æ —Ç–µ–±–µ –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π –º—ã –ø—Ä–æ–∂–∏–ª–∏ –≤–º–µ—Å—Ç–µ. –ó–∞ –∫–∞–∂–¥–æ–µ –æ–±—ä—è—Ç–∏–µ, –∑–∞ –∫–∞–∂–¥–æ–µ ‚Äú—Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏‚Äù, –∑–∞ –≤—Å–µ –Ω–∞—à–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –∏ –¥–∞–∂–µ –∑–∞ –º–∏–ª—ã–µ –≥–ª—É–ø–æ—Å—Ç–∏, –Ω–∞–¥ –∫–æ—Ç–æ—Ä—ã–º–∏ —Å–º–µ—ë–º—Å—è —Ç–æ–ª—å–∫–æ –º—ã.

–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é –æ —Ç–æ–º, –∫–∞–∫ –º–Ω–µ –ø–æ–≤–µ–∑–ª–æ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–µ–±—è. –ò –ø–æ–Ω–∏–º–∞—é: –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ –¥–æ —ç—Ç–æ–≥–æ, –±—É–¥—Ç–æ –≤–µ–ª–æ –∫ –æ–¥–Ω–æ–º—É –º–æ–º–µ–Ω—Ç—É ‚Äî –∫ –≤—Å—Ç—Ä–µ—á–µ —Å —Ç–æ–±–æ–π.

–Ø –Ω–µ –∑–Ω–∞—é, —á—Ç–æ –∂–¥—ë—Ç –Ω–∞—Å –≤–ø–µ—Ä–µ–¥–∏, –Ω–æ —Ç–æ—á–Ω–æ –∑–Ω–∞—é –æ–¥–Ω–æ: —è —Ö–æ—á—É, —á—Ç–æ–±—ã –≤ —ç—Ç–æ–º ‚Äú–≤–ø–µ—Ä–µ–¥–∏‚Äù –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —Ç—ã. –•–æ—á—É –¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –∑–∞ —Ä—É–∫—É, –∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Ç–µ–±–µ, —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ –∏ –¥–µ–ª–∞—Ç—å —Ç–µ–±—è —Å—á–∞—Å—Ç–ª–∏–≤–æ–π —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ç—ã –¥–µ–ª–∞–µ—à—å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º –º–µ–Ω—è.

–ü—Ä–æ—Å—Ç–æ –∑–Ω–∞–π: —Ç—ã –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –¥–ª—è –º–µ–Ω—è.  
–ë–æ–ª—å—à–µ, —á–µ–º –º–æ–≥—É—Ç –ø–µ—Ä–µ–¥–∞—Ç—å –ª—é–±—ã–µ —Å–ª–æ–≤–∞.

–ò –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Ç—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∑–∞–±—É–¥–µ—à—å, –∫–∞–∫ —Å–∏–ª—å–Ω–æ —è —Ç–µ–±—è –ª—é–±–ª—é ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π —ç—Ç–æ—Ç —Å–∞–π—Ç. –Ø —Å–¥–µ–ª–∞–ª –µ–≥–æ, —á—Ç–æ–±—ã —Ç—ã –≤—Å–µ–≥–¥–∞ –ø–æ–º–Ω–∏–ª–∞: –≤ —ç—Ç–æ–º –º–∏—Ä–µ –µ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ç—ã ‚Äî —Å–∞–º–æ–µ –¥–æ—Ä–æ–≥–æ–µ.

–° –ª—é–±–æ–≤—å—é,  
—Ç–≤–æ–π –ê—Ä—Å–µ–Ω–∏–π üíñ`;

export default function LetterSection() {
  const sectionRef = useRef(null);
  const [started, setStarted] = useState(false);
  const [typed, setTyped] = useState("");
  const words = useMemo(() => LETTER_TEXT.split(/\s+/), []);
  const hearts = useMemo(
    () =>
      Array.from({ length: 16 }).map(() => ({
        left: `${Math.random() * 100}%`,
        delay: `${Math.random() * 6}s`,
        duration: `${8 + Math.random() * 8}s`
      })),
    []
  );

  useEffect(() => {
    const node = sectionRef.current;
    if (!node) return undefined;

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setStarted(true);
          observer.disconnect();
        }
      },
      { threshold: 0.35 }
    );

    observer.observe(node);
    return () => observer.disconnect();
  }, []);

  useEffect(() => {
    if (!started) return undefined;
    let index = 0;
    setTyped("");
    const timer = setInterval(() => {
      index += 1;
      setTyped(words.slice(0, index).join(" "));
      if (index >= words.length) {
        clearInterval(timer);
      }
    }, 140);
    return () => clearInterval(timer);
  }, [started, words]);

  return (
    <section className={styles.section} ref={sectionRef}>
      <motion.div
        className={styles.content}
        initial={{ opacity: 0, y: 20 }}
        whileInView={{ opacity: 1, y: 0 }}
        viewport={{ once: true }}
        transition={{ duration: 0.7 }}
      >
        <h2 className={styles.title}>–ü—Ä–æ—á—Ç–∏ —ç—Ç–æ, –ù–∞—Å—Ç–µ–Ω—å–∫–∞ üíå</h2>
        <p className={styles.subtitle}>–Ø –Ω–∞–ø–∏—Å–∞–ª —Ç–µ–±–µ –∫–æ–µ-—á—Ç–æ –≤–∞–∂–Ω–æ–µ</p>

        <div className={styles.letterCard}>
          <p className={styles.letterText}>
            {typed}
            <span className={styles.caret} />
          </p>
        </div>
      </motion.div>

      <div className={styles.floatingHearts}>
        {hearts.map((heart, index) => (
          <span
            key={`letter-heart-${index}`}
            className={styles.heart}
            style={{
              left: heart.left,
              animationDelay: heart.delay,
              animationDuration: heart.duration
            }}
          />
        ))}
      </div>
    </section>
  );
}
